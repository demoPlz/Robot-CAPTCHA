<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Control Task - MTurk</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }
        
        .mturk-header {
            background: #232f3e;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mturk-header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .instructions {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .instructions h2 {
            margin-top: 0;
            color: #232f3e;
        }
        
        .instructions ul {
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .demo-video-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .demo-video-section h2 {
            margin-top: 0;
            color: #232f3e;
            margin-bottom: 10px;
        }
        
        .demo-video-section .video-description {
            margin-bottom: 15px;
            color: #374151;
            line-height: 1.5;
        }
        
        .demo-video-section video {
            width: 100%;
            max-width: 900px;
            border-radius: 4px;
            background: #000;
            display: block;
        }
        
        .demo-video-section .no-video {
            padding: 40px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
            background: #f9fafb;
            border-radius: 4px;
        }
        
        .task-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        #task-iframe {
            width: 100%;
            height: 900px;
            border: none;
            border-radius: 4px;
        }
        
        .completion-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .completion-overlay.active {
            display: flex;
        }
        
        .completion-message {
            text-align: center;
            padding: 40px;
        }
        
        .completion-message h2 {
            color: #22c55e;
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        .completion-message p {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .submit-button {
            background: #ff9900;
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .submit-button:hover {
            background: #ec7211;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="mturk-header">
        <h1>ðŸ¤– Robot Arm Control Task</h1>
    </div>
    
    <div class="content-wrapper">
        <div class="instructions">
            <h2>Instructions</h2>
            <ul id="instructions-list">
                <li>Loading instructions...</li>
            </ul>
        </div>
        
        <div class="instructions" id="task-instructions-container" style="display: none;">
            <h2 id="task-instructions-title">Task Instructions</h2>
            <ul id="task-instructions-list">
            </ul>
        </div>
        
        <div class="demo-video-section" id="demo-video-section">
            <h2>Example Video</h2>
            <div id="demo-video-description" class="video-description">
                Watch this example demonstration to understand the task better.
            </div>
            <video id="demo-video" controls loop style="display: none;">
                <source id="demo-video-source" type="video/webm">
                Your browser does not support the video tag.
            </video>
            <div class="no-video" id="no-video-message">
                Loading video...
            </div>
        </div>
        
        <div class="task-container">
            <div id="task-iframe-wrapper">
                <div class="loading">Loading task...</div>
            </div>
            
            <div id="completion-overlay" class="completion-overlay">
                <div class="completion-message">
                    <h2>âœ… Task Completed!</h2>
                    <p>Thank you for your submission.</p>
                    <p>Your response has been recorded successfully.</p>
                    <button class="submit-button" onclick="submitHIT()">Submit HIT to MTurk</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load instructions from file
        async function loadInstructions() {
            try {
                const response = await fetch('/api/mturk/instructions');
                const instructions = await response.json();
                
                const instructionsList = document.getElementById('instructions-list');
                instructionsList.innerHTML = '';
                
                instructions.forEach((section) => {
                    if (section.trim()) {
                        const li = document.createElement('li');
                        // Render HTML content directly (preserves formatting, numbered lists, etc.)
                        li.innerHTML = section;
                        instructionsList.appendChild(li);
                    }
                });
            } catch (error) {
                console.error('Failed to load instructions:', error);
                // Fallback to default
                document.getElementById('instructions-list').innerHTML = 
                    '<li><strong>Goal:</strong> Help control a robot arm to complete a manipulation task</li>' +
                    '<li><strong>Task:</strong> You\'ll see a robot simulation. Your job is to specify the next position for the robot to move to</li>' +
                    '<li><strong>Controls:</strong> Use the interface controls to adjust the robot\'s position and gripper</li>' +
                    '<li><strong>Verification:</strong> Use the "Simulate" button to preview your action before submitting</li>' +
                    '<li><strong>Submit:</strong> Once you\'re satisfied with your choice, click "Confirm" to submit</li>' +
                    '<li><strong>Important:</strong> After submitting, you\'ll see a completion message. Click "Submit HIT" to finalize your work</li>';
            }
        }
        
        // Load task-specific instructions
        async function loadTaskInstructions() {
            try {
                const response = await fetch('/api/mturk/task-instructions');
                const data = await response.json();
                
                if (data.title && data.sections && data.sections.length > 0) {
                    // Show the container
                    document.getElementById('task-instructions-container').style.display = 'block';
                    
                    // Set custom title
                    document.getElementById('task-instructions-title').textContent = data.title;
                    
                    // Populate sections
                    const taskList = document.getElementById('task-instructions-list');
                    taskList.innerHTML = '';
                    
                    data.sections.forEach((section) => {
                        if (section.trim()) {
                            const li = document.createElement('li');
                            li.innerHTML = section;
                            taskList.appendChild(li);
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load task-specific instructions:', error);
                // Silently fail - task instructions are optional
            }
        }
        
        // Load demo video for the current state
        async function loadDemoVideo() {
            const videoElement = document.getElementById('demo-video');
            const videoSource = document.getElementById('demo-video-source');
            const noVideoMessage = document.getElementById('no-video-message');
            const descriptionDiv = document.getElementById('demo-video-description');
            
            try {
                // Fetch state to get example_video_url (same as sim.html info button)
                const stateResponse = await fetch('/api/get-state');
                if (!stateResponse.ok) {
                    noVideoMessage.textContent = 'Failed to load state data.';
                    return;
                }
                
                const state = await stateResponse.json();
                const videoUrl = state.example_video_url;
                
                if (!videoUrl) {
                    noVideoMessage.textContent = 'No demonstration video available for this task.';
                    return;
                }
                
                // Load description from shared description file
                try {
                    const descResponse = await fetch('/api/video-description/latest');
                    if (descResponse.ok) {
                        const descText = await descResponse.text();
                        if (descText && descText.trim()) {
                            descriptionDiv.innerHTML = descText;
                        }
                    }
                } catch (descError) {
                    console.warn('Failed to load description:', descError);
                }
                
                // Show video
                noVideoMessage.style.display = 'none';
                videoSource.src = videoUrl;
                videoElement.style.display = 'block';
                videoElement.load();
                
                videoElement.muted = true;
                videoElement.play().catch(err => {
                    console.warn('Autoplay failed:', err);
                });
            } catch (error) {
                console.error('Failed to load demo video:', error);
                noVideoMessage.textContent = 'Error loading video.';
            }
        }
        
        // Load instructions on page load
        loadInstructions();
        loadTaskInstructions();
        loadDemoVideo();
        
        // Get episode_id and state_id from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const episodeId = urlParams.get('episode_id');
        const stateId = urlParams.get('state_id');
        
        // Track submission state
        let submissionCompleted = false;
        
        // Check if we have required parameters
        if (!episodeId || !stateId) {
            // For testing: load sim.html without mturk parameters
            console.warn('Missing episode_id/state_id parameters - loading sim.html for testing');
            const iframe = document.createElement('iframe');
            iframe.id = 'task-iframe';
            iframe.src = `sim.html`;
            document.getElementById('task-iframe-wrapper').innerHTML = '';
            document.getElementById('task-iframe-wrapper').appendChild(iframe);
            
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'submission_complete') {
                    console.log('âœ… Submission complete, showing overlay');
                    submissionCompleted = true;
                    document.getElementById('completion-overlay').classList.add('active');
                }
            });
        } else {
            // Load the actual task interface in an iframe
            const iframe = document.createElement('iframe');
            iframe.id = 'task-iframe';
            iframe.src = `sim.html?mturk=1&episode_id=${episodeId}&state_id=${stateId}`;
            
            // Replace loading message with iframe
            document.getElementById('task-iframe-wrapper').innerHTML = '';
            document.getElementById('task-iframe-wrapper').appendChild(iframe);
            
            // Listen for submission completion from the iframe
            window.addEventListener('message', function(event) {
                // Verify message origin for security
                if (event.data && event.data.type === 'submission_complete') {
                    console.log('âœ… Submission complete, showing overlay');
                    submissionCompleted = true;
                    document.getElementById('completion-overlay').classList.add('active');
                }
            });
        }
        
        function submitHIT() {
            if (!submissionCompleted) {
                alert('Please complete the task first');
                return;
            }
            
            // In MTurk, we would submit the form here
            // For now, just show a message
            if (window.opener || window.parent !== window) {
                // If in MTurk iframe, close window
                alert('Task submitted successfully! You can close this window.');
            } else {
                alert('Task submitted successfully!\n\nIn production MTurk, this would submit your HIT automatically.');
            }
            
            // Optionally, could call MTurk's ExternalQuestion submit
            // document.getElementById('submitButton').click();
        }
        
        // Prevent accidental navigation away
        window.addEventListener('beforeunload', function(e) {
            if (!submissionCompleted) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your work may not be saved.';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>
